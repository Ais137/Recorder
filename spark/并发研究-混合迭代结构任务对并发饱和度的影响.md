# 并发研究-混合迭代结构任务对并发饱和度的影响

采集系统的理想并发状态应该是保持在设置的并发限制水平附近平稳波动的。(在任务饱和的情况下)

但是在某种场景下，比如系统采用批处理模式，每次获取一批任务来并发执行，对于短耗时任务，这种方式一般可以保持上述理想的并发状态。但如果其中混合了一些长耗时任务，那么将导致一种 *木桶效应*，即由于长耗时任务的存在，无法执行下一批任务，从而导致每一批任务的后期并发不饱和，导致系统整体的并发效果降低，并发数-时间曲线呈现出一种连续的三角折线。

举一个典型的应用场景 —— 社交媒体数据采集。通常这类采集任务包含两个主要任务，一是采集目标用户的帖子信息，二是采集该帖子对应的评论信息。这两类任务从迭代结构上是有很大区别的，这也导致了两类任务的采集耗时的差异。对于帖子数据，通常是列表页+详情页组成的，这种结构很好控制并发，翻页结构也是线性的。这意味着采集耗时一般是明确且可控的。但是对于评论数据，其迭代结构通常是复杂的，特别是对于包含嵌套回复的数据，往往除了分页结构还具有嵌套的树状结构，这意味着采集时间是不明确的。如果采用上述批处理模式构建的采集系统，这种混合任务会导致并发不饱和的问题。

因此需要对上述问题进行深入研究以探索解决方案。

主要研究的问题有以下几点：

1. 构建一个基于线程池的批处理并发系统，并测试其在单一迭代结构任务(短耗时任务)和混合迭代结构任务下的并发饱和状态，通过打点统计并发数来生成 并发数-时间 曲线。

2. 研究 scrapy-redis 框架的任务获取逻辑，并验证其并发效果是否会受混合迭代结构任务的影响。

3. 探索解决方案
    1. 核心数据与次要数据的分离采集方案研究。
    2. 优先级队列调度方案