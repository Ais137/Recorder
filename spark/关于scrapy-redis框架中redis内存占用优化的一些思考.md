# 关于scrapy-redis框架中redis内存占用优化的一些思考

对于基于scrapy-redis的爬虫架构，redis做为框架运行的中间件，主要功能有两个

1. 任务队列(业务任务与下载器任务)
2. 请求去重器

那么分析redis内存占用过高的原因可以从上述两个方向入手。

### 1. 任务队列堆积导致的redis内存占用过高
当采集器的消耗速度低于任务调度器的分发速度时，可能导致任务在redis队列中堆积，从而导致内存占用过高，这种情况下，可以从两个方向优化：
1. 通过扩展采集器数量来提高系统的任务消耗速度
2. 自适应任务调度器设计：通过一个阈值来控制任务队列的饱和状态，根据任务队列的实时消耗速度与阈值的差异来决定任务数的分发数。该阈值参数可以通过分析任务队列中任务数量的时间序列来确定一个最优值，同时该方法不适用与实时性要求较高的业务
3. 自适应采集进程调度器：根据 redis 队列的消耗速度自动调度采集进程以适应任务的分发速度。

### 2. 请求去重器导致的redis内存占用过高
在scrapy-redis框架中，通过redis进行请求的去重处理。最常见的方式是采用 set 进行去重，一个优化方法是采用布隆过滤器来减少去重器的内存开销。但是随着系统运行时间变长，该方案还是会导致内存占用问题。

另一个方案是通过分析采集逻辑，设计一套缓存失效系统，定期对去重器缓存数据进行清理，比如针对增量采集架构，可以设计一种 *基于时间失效的去重器* 的设计，使其内存占用随时间保持一定的恒定水平。
